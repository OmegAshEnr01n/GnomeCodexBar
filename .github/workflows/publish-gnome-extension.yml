name: Publish GNOME Extension

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'extension/**'

permissions:
  contents: write

env:
  EXT_UUID: usage-tui@gnome.codexbar
  EXT_DIR: extension
  DIST_DIR: dist
  EXT_ZIP: usage-tui@gnome.codexbar.shell-extension.zip

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build extension zip
        run: |
          mkdir -p "$DIST_DIR"
          cd "$EXT_DIR"
          zip -r "../$DIST_DIR/$EXT_ZIP" . -x "dev.sh" -x "*.md"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gnome-extension
          path: dist/${{ env.EXT_ZIP }}

      - name: Attach to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.EXT_ZIP }}

      - name: Reminder for EGO upload
        if: github.event_name == 'release'
        run: |
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚  ğŸ“¦ Extension built and attached to release!            â”‚"
          echo "â”‚                                                         â”‚"
          echo "â”‚  To publish on extensions.gnome.org:                    â”‚"
          echo "â”‚  1. Download: ${{ env.EXT_ZIP }}                        â”‚"
          echo "â”‚  2. Go to: https://extensions.gnome.org/upload/         â”‚"
          echo "â”‚  3. Login and upload the zip                            â”‚"
          echo "â”‚                                                         â”‚"
          echo "â”‚  Note: EGO has no public API for automated uploads.     â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
